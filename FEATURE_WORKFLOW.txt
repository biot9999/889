┌─────────────────────────────────────────────────────────────────────────────┐
│                  补货通知自动镜像功能工作流程图                              │
│           Restock Notification Mirroring Feature Workflow                   │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────────┐
                              │  总部通知群      │
                              │ HQ Notify Group  │
                              └────────┬─────────┘
                                       │
                                       │ 发送消息
                                       │ Send Message
                                       ▼
                            ┌─────────────────────┐
                            │   代理机器人监听     │
                            │  Agent Bot Listens  │
                            └──────────┬──────────┘
                                       │
                        ┌──────────────┴──────────────┐
                        │ 检查消息来源                 │
                        │ Check Message Source         │
                        │ chat.id == HQ_CHAT_ID?      │
                        └──────────┬──────────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
                   否 No                         是 Yes
                    │                             │
                    ▼                             ▼
            ┌──────────────┐          ┌──────────────────┐
            │   忽略消息    │          │  提取消息文本    │
            │ Ignore Message│          │ Extract Message │
            └──────────────┘          └────────┬─────────┘
                                               │
                                    ┌──────────┴──────────┐
                                    │  关键词匹配          │
                                    │ Keyword Matching     │
                                    │ Contains keywords?   │
                                    └──────────┬──────────┘
                                               │
                                ┌──────────────┴──────────────┐
                                │                             │
                               否 No                         是 Yes
                                │                             │
                                ▼                             ▼
                        ┌──────────────┐          ┌──────────────────────┐
                        │   忽略消息    │          │ 📋 记录关键词匹配     │
                        │ Ignore Message│          │    Log Match Found   │
                        └──────────────┘          └──────────┬───────────┘
                                                              │
                                                   ┌──────────┴──────────┐
                                                   │ 尝试 copy_message    │
                                                   │ Try copy_message     │
                                                   └──────────┬──────────┘
                                                              │
                                               ┌──────────────┴──────────────┐
                                               │                             │
                                            成功 Success                  失败 Fail
                                               │                             │
                                               ▼                             ▼
                                    ┌──────────────────┐        ┌──────────────────┐
                                    │ ✅ 转发成功       │        │ ⚠️ 记录失败      │
                                    │   Forwarded      │        │   Log Failure    │
                                    └────────┬─────────┘        └────────┬─────────┘
                                             │                           │
                                             │                           ▼
                                             │              ┌────────────────────────┐
                                             │              │ 尝试 send_message       │
                                             │              │ Try send_message        │
                                             │              │ (根据消息类型)          │
                                             │              │ (Based on message type)│
                                             │              └────────────┬───────────┘
                                             │                           │
                                             │            ┌──────────────┴──────────────┐
                                             │            │                             │
                                             │         成功 Success                  失败 Fail
                                             │            │                             │
                                             │            ▼                             ▼
                                             │  ┌──────────────────┐        ┌──────────────────┐
                                             │  │ ✅ 回退成功       │        │ ❌ 完全失败       │
                                             │  │   Fallback OK    │        │   Total Failure  │
                                             │  └────────┬─────────┘        └──────────────────┘
                                             │           │
                                             └───────────┴─────────────┐
                                                         │             │
                                          ┌──────────────┴─────────────┴─────────┐
                                          │ 检查是否启用按钮重写                  │
                                          │ Check if button rewriting enabled?    │
                                          │ RESTOCK_REWRITE_BUTTONS == 1?        │
                                          └──────────────┬───────────────────────┘
                                                         │
                                          ┌──────────────┴──────────────┐
                                          │                             │
                                         否 No                         是 Yes
                                          │                             │
                                          ▼                             ▼
                                  ┌──────────────┐          ┌──────────────────────┐
                                  │   完成        │          │ 发送重写按钮          │
                                  │   Done       │          │ Send Rewritten Buttons│
                                  └──────────────┘          │ • 购买商品            │
                                                            │ • 打开机器人          │
                                                            └──────────┬───────────┘
                                                                       │
                                                                       ▼
                                                            ┌──────────────────────┐
                                                            │   完成               │
                                                            │   Done              │
                                                            └─────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              消息类型处理                                    │
│                          Message Type Handling                              │
└─────────────────────────────────────────────────────────────────────────────┘

copy_message 失败后的 send_message 处理:

┌──────────────┐
│ 消息类型     │
│ Message Type │
└──────┬───────┘
       │
       ├─── 📝 纯文本 Text Only        → send_message(text=...)
       │
       ├─── 🖼️ 图片+文本 Photo+Text    → send_photo(photo=..., caption=...)
       │
       ├─── 🎬 视频+文本 Video+Text    → send_video(video=..., caption=...)
       │
       └─── 📄 文档+文本 Document+Text → send_document(document=..., caption=...)

┌─────────────────────────────────────────────────────────────────────────────┐
│                              关键配置项                                      │
│                         Key Configuration Items                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────┬─────────────────┬──────────────────────────┐
│ 环境变量                       │ 必需/可选       │ 说明                      │
│ Environment Variable           │ Required/Opt    │ Description              │
├────────────────────────────────┼─────────────────┼──────────────────────────┤
│ HEADQUARTERS_NOTIFY_CHAT_ID    │ ✅ 必需         │ 总部通知群ID              │
│                                │    Required     │ HQ notification group ID │
├────────────────────────────────┼─────────────────┼──────────────────────────┤
│ AGENT_NOTIFY_CHAT_ID           │ ✅ 必需         │ 代理通知群ID              │
│                                │    Required     │ Agent notification group │
├────────────────────────────────┼─────────────────┼──────────────────────────┤
│ AGENT_RESTOCK_NOTIFY_CHAT_ID   │ ⭕ 可选         │ 专用补货通知群ID          │
│                                │    Optional     │ Dedicated restock group  │
├────────────────────────────────┼─────────────────┼──────────────────────────┤
│ RESTOCK_KEYWORDS               │ ⭕ 可选         │ 补货关键词列表            │
│                                │    Optional     │ Restock keyword list     │
├────────────────────────────────┼─────────────────┼──────────────────────────┤
│ RESTOCK_REWRITE_BUTTONS        │ ⭕ 可选         │ 是否重写按钮              │
│                                │    Optional     │ Enable button rewriting  │
└────────────────────────────────┴─────────────────┴──────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              安全机制                                        │
│                          Security Mechanisms                                │
└─────────────────────────────────────────────────────────────────────────────┘

1. 🔒 循环防止 / Loop Prevention
   ├─ 只处理来自 HEADQUARTERS_NOTIFY_CHAT_ID 的消息
   └─ 其他群组消息一律忽略

2. 🔒 权限最小化 / Minimal Permissions
   ├─ HQ群: 只需读取消息权限
   └─ 代理群: 只需发送消息和媒体权限

3. 🔒 按钮重写默认禁用 / Button Rewriting Default Off
   ├─ 避免误导用户
   └─ 需要时手动启用

4. 🔒 详细日志 / Detailed Logging
   ├─ 每次转发都有记录
   └─ 错误情况有堆栈跟踪

┌─────────────────────────────────────────────────────────────────────────────┐
│                              日志示例                                        │
│                            Log Examples                                     │
└─────────────────────────────────────────────────────────────────────────────┘

✅ 成功转发 / Successful Forwarding:
INFO - 🔔 检测到补货通知（关键词: 补货通知）: 🎉 【新品上架】TG账号大批量补货...
INFO - ✅ 补货通知已镜像到 -1009876543210 (message_id: 12345)

⚠️ copy_message 失败回退 / copy_message Fallback:
WARNING - ⚠️ copy_message 失败（可能是权限问题）: Bad Request: not enough rights
INFO - 🔄 尝试使用 send_message 回退方案...
INFO - ✅ 补货通知已通过回退方案发送到 -1009876543210

✅ 按钮重写 / Button Rewriting:
INFO - ✅ 补货通知已镜像到 -1009876543210 (message_id: 12345)
INFO - ✅ 补货通知按钮已重写

