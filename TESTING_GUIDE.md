# 测试指南 - Testing Guide

本文档提供详细的测试步骤，用于验证三个主要问题的修复。

## 前置条件

1. 确保已安装所有依赖：`pip install -r requirements.txt`
2. 配置好 `.env` 文件
3. MongoDB 已启动并可连接
4. 至少有一个可用的 Telegram 账户

---

## 测试场景 1: Postbot 发送验证

### 目标
验证 postbot 代码无效时，系统会正确标记为失败而不是假成功。

### 测试步骤

#### 测试 1.1: 有效的 Postbot 代码
1. 启动机器人：`python3 bot.py`
2. 在 Telegram 中发送 `/start`
3. 点击"📝 任务管理" → "➕ 创建新任务"
4. 输入任务名称：`测试Postbot有效代码`
5. 选择发送方式：🤖 Post代码
6. 输入一个**有效**的 postbot 代码（从 @postbot 获取）
7. 上传目标用户列表（1-2个测试用户）
8. 开始任务
9. **预期结果**：
   - ✅ 消息成功发送
   - 目标用户收到带按钮的消息
   - 日志显示"✅ 成功"

#### 测试 1.2: 无效的 Postbot 代码
1. 创建新任务：`测试Postbot无效代码`
2. 选择发送方式：🤖 Post代码
3. 输入一个**无效**的代码（如：`invalid12345`）
4. 上传目标用户列表
5. 开始任务
6. **预期结果**：
   - ❌ 发送失败
   - 错误信息："Post代码无效或已过期"
   - 任务运行日志中显示详细失败原因
   - **不会**显示"发送成功"

### 验证要点
- [ ] 无效代码被正确标记为失败
- [ ] 日志中包含友好的错误描述
- [ ] 不会出现"假成功"情况

---

## 测试场景 2: UI 显示验证

### 目标
验证新的 UI 显示格式（emoji + 无括号）。

### 测试步骤

#### 测试 2.1: 任务详情页面
1. 创建任务并添加 5000 个目标用户
2. 开始任务
3. 在任务运行时，点击"查看任务详情"
4. **预期显示格式**：
```
⬇ 正在私信中 ⬇
进度 20/5000 (0.4%)

👥 总用户数    5000
✅ 发送成功    20
❌ 发送失败    2
```

5. **验证要点**：
   - [ ] 使用 emoji 图标（👥, ✅, ❌）
   - [ ] **没有**括号【】
   - [ ] 数字正确显示
   - [ ] 格式清晰易读

#### 测试 2.2: 内联按钮显示
1. 在任务运行时观察内联按钮
2. **预期按钮布局**：
```
[👥 总用户数] [5000]
[✅ 发送成功] [20]
[❌ 发送失败] [2]
[🔄 刷新进度] [⏸️ 停止任务]
```

3. **验证要点**：
   - [ ] 左侧按钮显示 emoji + 中文标签
   - [ ] 右侧按钮显示纯数字
   - [ ] **没有**括号【】
   - [ ] 按钮可点击且功能正常

#### 测试 2.3: 进度刷新
1. 点击"🔄 刷新进度"按钮
2. **预期结果**：
   - [ ] 数字立即更新
   - [ ] 显示格式保持一致
   - [ ] 无闪烁或错误

---

## 测试场景 3: 详细日志验证

### 目标
验证任务运行日志包含详细的账户统计和发送记录。

### 测试步骤

#### 测试 3.1: 基本日志生成
1. 创建任务并使用多个账户（至少 2 个）
2. 添加目标用户列表（20-50 个用户）
3. 确保有成功和失败的发送
4. 等待任务完成
5. 下载"任务运行日志.txt"

#### 测试 3.2: 验证日志内容

**检查文件头部**：
```
任务运行日志
任务ID: xxxxxxxxxxxxxxxxx
完成时间: 2025-12-12 15:30:00
==================================================
```

**检查账户统计部分**：
```
📊 账户统计:
--------------------------------------------------

📱 账户: +861234567890
   ✅ 已成功发送: 10条
   ❌ 发送失败: 2条
   失败原因统计:
      • 账户隐私限制（对方设置了隐私保护）: 1次
      • 非双向联系人（需要互相添加好友）: 1次

📱 账户: +861234567891
   ✅ 已成功发送: 8条
   ❌ 发送失败: 0条
```

**验证要点**：
- [ ] 每个账户显示完整手机号
- [ ] 成功/失败计数准确
- [ ] 失败原因已分类
- [ ] 失败原因显示为中文友好描述

**检查详细记录部分**：
```
📝 详细发送记录:
--------------------------------------------------

[2025-12-12 15:25:30.123456]
账户: +861234567890
目标: @username123
状态: ✅ 成功
私信内容: 你好，这是一条测试消息...

[2025-12-12 15:25:35.789012]
账户: +861234567890
目标: @blocked_user
状态: ❌ 失败
失败原因: 已被对方屏蔽
详细错误: UserIsBlockedError: The user blocked you
```

**验证要点**：
- [ ] 每条记录包含时间戳
- [ ] 显示账户手机号
- [ ] 显示目标用户名
- [ ] 成功记录显示消息内容预览
- [ ] 失败记录显示友好的失败原因
- [ ] 失败记录显示详细技术错误

#### 测试 3.3: 错误分类验证

触发以下各种错误类型并验证日志中的分类：

| 触发方式 | 预期分类 |
|---------|---------|
| 目标用户设置隐私保护 | 账户隐私限制（对方设置了隐私保护） |
| 被目标用户屏蔽 | 已被对方屏蔽 |
| 非双向联系人 | 非双向联系人（需要互相添加好友） |
| 发送过快被限流 | 账户已被限流（发送过多消息） |
| 无效的 postbot 代码 | Post代码无效或已过期 |
| 用户不存在 | 用户不存在或已失效 |
| 网络超时 | 网络连接超时 |

**验证要点**：
- [ ] 每种错误都有对应的中文描述
- [ ] 错误分类准确
- [ ] 描述清晰易懂

---

## 测试场景 4: 性能验证

### 目标
验证数据库查询优化（N+1 问题已解决）。

### 测试步骤

#### 测试 4.1: 大量日志性能
1. 创建任务并添加 1000+ 个目标用户
2. 使用 5 个不同账户
3. 让任务完成（或停止）
4. 观察生成日志文件的时间
5. **预期结果**：
   - 日志生成时间 < 5 秒（即使有 1000+ 条记录）
   - 没有明显的卡顿或延迟

#### 测试 4.2: 数据库查询验证
1. 启用 MongoDB 查询日志
2. 生成包含 100 条日志的报告
3. 查看查询日志
4. **预期结果**：
   - 只有 2 次查询（1次查询账户，1次查询目标）
   - **不是** 100+ 次查询

---

## 测试场景 5: 边界情况和错误处理

### 测试 5.1: 空值处理
1. 创建任务但不添加消息内容（使用空字符串）
2. 开始并完成任务
3. 检查日志文件
4. **预期结果**：
   - [ ] 不会崩溃
   - [ ] 消息内容显示为空或"(无内容)"
   - [ ] 日志格式正常

### 测试 5.2: 特殊字符处理
1. 创建包含 emoji、中文、特殊符号的消息
2. 完成任务
3. 检查日志文件
4. **预期结果**：
   - [ ] 特殊字符正确显示
   - [ ] 没有编码错误
   - [ ] 文件格式正常

### 测试 5.3: 无效 ObjectId 处理
1. 手动修改数据库，插入无效的 account_id 或 target_id
2. 尝试生成日志
3. **预期结果**：
   - [ ] 不会崩溃
   - [ ] 无效 ID 被跳过或显示为"Unknown"
   - [ ] 其他有效记录正常显示

---

## 测试检查清单

### 问题 1: Postbot 发送 ✅
- [ ] 有效代码正常发送
- [ ] 无效代码标记为失败（不是假成功）
- [ ] 错误日志准确

### 问题 2: UI 显示 ✅
- [ ] 使用 emoji 图标
- [ ] 没有括号【】
- [ ] 数字显示正确
- [ ] 布局清晰美观

### 问题 3: 详细日志 ✅
- [ ] 账户统计包含手机号
- [ ] 每账户成功/失败计数
- [ ] 错误原因已分类（中文友好）
- [ ] 详细记录包含所有元数据
- [ ] 消息内容预览

### 性能 ✅
- [ ] 大量日志快速生成（< 5秒）
- [ ] 只有 2 次数据库查询

### 边界情况 ✅
- [ ] 空值不会崩溃
- [ ] 特殊字符正确处理
- [ ] 无效 ID 安全处理

---

## 回归测试

确保新功能不影响现有功能：

- [ ] 账户管理功能正常
- [ ] 任务创建流程正常
- [ ] 发送方式（直接发送、频道转发）正常
- [ ] 停止任务功能正常
- [ ] 导出结果功能正常
- [ ] 配置参数功能正常

---

## 报告问题

如果发现任何问题，请记录：

1. **问题描述**：详细描述问题
2. **重现步骤**：如何触发问题
3. **预期结果**：应该发生什么
4. **实际结果**：实际发生了什么
5. **日志截图**：相关日志或错误信息
6. **环境信息**：Python 版本、MongoDB 版本、操作系统

---

## 测试完成标准

所有测试场景通过，且：
- ✅ 没有崩溃或异常
- ✅ UI 显示符合预期
- ✅ 日志信息完整准确
- ✅ 性能表现良好
- ✅ 边界情况处理正确
- ✅ 现有功能未受影响

**测试通过后，即可部署到生产环境！** 🚀
